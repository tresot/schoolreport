<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SchoolReport</title>
    <style>
        :root {
            --primary: #2E8B57; /* Vert pomme */
            --secondary: #1a5c38; /* Vert pomme plus foncé */
            --light: #F8F4E6; /* Blanc cassé */
            --dark: #0A192F; /* Bleu marine foncé */
            --success: #64FFDA; /* Vert menthe */
            --warning: #f8961e;
            --danger: #e63946;
            --calendar: #3B82F6; /* Bleu clair pour le calendrier */
            --text-primary: #CCD6F6; /* Texte principal */
            --text-secondary: #8892B0; /* Texte secondaire */
            --input-bg: #112240; /* Fond des inputs */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dark);
            min-height: 100vh;
            color: var(--text-primary);
            background-image: url('photos/background.webp');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .overlay {
            background-color: rgba(10, 25, 47, 0.9);
            min-height: 100vh;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(100, 255, 218, 0.1);
            margin-bottom: 50px;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo h1 {
            color: var(--primary);
            font-size: 28px;
            margin-left: 10px;
        }

        .time-online {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .time {
            background: rgba(16, 36, 69, 0.5);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 16px;
            border: 1px solid rgba(100, 255, 218, 0.1);
        }

        .user-menu {
            display: flex;
            align-items: center;
            position: relative;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary);
            color: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .user-name {
            font-weight: 500;
            font-size: 18px;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            margin-left: 20px;
            font-size: 16px;
            transition: opacity 0.3s;
            padding: 8px 15px;
            border-radius: 5px;
        }

        .logout-btn:hover {
            opacity: 0.8;
            background: rgba(230, 57, 70, 0.1);
        }

        /* Main content layout */
        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 60px;
        }

        /* Profile card */
        .profile-card {
            background: rgba(16, 36, 69, 0.7);
            border-radius: 20px;
            padding: 40px;
            width: 350px;
            text-align: center;
            margin-bottom: 40px;
            border: 1px solid rgba(100, 255, 218, 0.1);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            transition: transform 0.5s, box-shadow 0.5s;
        }

        .profile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .profile-image {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 25px;
            overflow: hidden;
            border: 4px solid var(--primary);
            position: relative;
            transition: all 0.5s;
        }

        .profile-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.5s;
        }

        .profile-image .initials {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary);
            color: white;
            font-size: 50px;
            font-weight: bold;
            transition: opacity 0.5s;
        }

        .profile-card h2 {
            margin-bottom: 15px;
            color: var(--text-primary);
            font-size: 24px;
        }

        .profile-card p {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 25px;
        }

        /* Description card */
        .description-card {
            background: rgba(16, 36, 69, 0.7);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 700px;
            margin-bottom: 40px;
            border: 1px solid rgba(100, 255, 218, 0.1);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: center;
        }

        .description-card h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 24px;
        }

        .description-card p {
            color: var(--text-secondary);
            line-height: 1.8;
            font-size: 16px;
            margin-bottom: 30px;
        }

        /* Mini cards container */
        .mini-cards-container {
            width: 100%;
            overflow-x: auto;
            padding: 30px 0;
            margin-bottom: 50px;
            scrollbar-width: none;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        .mini-cards-container::-webkit-scrollbar {
            display: none;
        }

        .mini-cards-track {
            display: flex;
            gap: 25px;
            padding: 15px;
            transition: transform 0.5s ease-out;
            width: max-content;
        }

        .mini-card {
            width: 150px;
            height: 150px;
            border-radius: 20px;
            overflow: hidden;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 3px solid rgba(100, 255, 218, 0.3);
            position: relative;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .mini-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }

        .mini-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.5s;
        }

        .mini-card.active {
            border: 3px solid var(--primary);
            box-shadow: 0 0 25px rgba(46, 139, 87, 0.7);
            transform: scale(1.1);
        }

        .mini-card .card-title {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 25, 47, 0.8);
            color: var(--text-primary);
            padding: 10px;
            text-align: center;
            font-size: 14px;
            transform: translateY(100%);
            transition: transform 0.3s;
            opacity: 0;
        }

        .mini-card:hover .card-title {
            transform: translateY(0);
            opacity: 1;
        }

        .active-indicator {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: var(--danger);
            color: var(--light);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            z-index: 2;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Responsive layout */
        @media (min-width: 992px) {
            .profile-section {
                display: flex;
                justify-content: center;
                align-items: flex-start;
                gap: 40px;
                width: 100%;
                max-width: 1200px;
                margin-bottom: 60px;
            }

            .profile-card {
                margin-bottom: 0;
                width: 350px;
            }

            .description-card {
                margin-bottom: 0;
                flex: 1;
                max-width: 800px;
            }
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 20px;
            }

            .time-online {
                order: 3;
                margin-top: 20px;
            }

            .profile-card, .description-card {
                width: 100%;
                max-width: 100%;
            }

            .mini-card {
                width: 120px;
                height: 120px;
            }
        }

        /* Online users dropdown */
        .profile-badge {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .online-status {
            position: absolute;
            bottom: -3px;
            right: -3px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #2ecc71;
            border: 2px solid var(--light);
            z-index: 1;
        }
        
        .user-count {
            background-color: var(--primary);
            color: var(--light);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            margin-left: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-count:hover {
            background-color: var(--secondary);
            transform: scale(1.05);
        }

        /* Modals */
        #setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #setup-modal.show {
            opacity: 1;
            pointer-events: all;
        }

        .setup-container {
            background: var(--dark);
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            border: 1px solid rgba(100, 255, 218, 0.1);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        #setup-modal.show .setup-container {
            transform: scale(1);
        }

        .setup-container h2 {
            margin-bottom: 25px;
            color: var(--text-primary);
            font-size: 28px;
        }

        .setup-container input {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid rgba(100, 255, 218, 0.3);
            border-radius: 10px;
            font-size: 16px;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .setup-container input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(46, 139, 87, 0.5);
            outline: none;
        }

        .profile-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 25px auto;
            background-color: var(--primary);
            color: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            overflow: hidden;
            position: relative;
            border: 3px solid rgba(100, 255, 218, 0.3);
        }

        .profile-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .setup-btn {
            background-color: var(--primary);
            color: var(--light);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            margin-top: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .setup-btn:hover {
            background-color: var(--secondary);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .users-list {
            position: absolute;
            top: 60px;
            right: 0;
            background: var(--dark);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 20px;
            width: 250px;
            display: none;
            z-index: 100;
            border: 1px solid rgba(100, 255, 218, 0.1);
            transform: translateY(10px);
            opacity: 0;
            transition: all 0.3s;
        }

        .users-list.show {
            display: block;
            transform: translateY(0);
            opacity: 1;
        }

        .users-list h4 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid rgba(100, 255, 218, 0.1);
            padding-bottom: 10px;
        }

        .user-item {
            display: flex;
            align-items: center;
            margin: 12px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(100, 255, 218, 0.05);
        }

        .user-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            color: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            font-size: 18px;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }

        .user-avatar-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        #image-input-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #image-input-modal.show {
            display: flex;
            opacity: 1;
        }

        .image-input-container {
            background: var(--dark);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(100, 255, 218, 0.1);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        #image-input-modal.show .image-input-container {
            transform: scale(1);
        }

        .image-input-container h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 22px;
        }

        .image-input-container p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .image-input-container input {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            background: var(--input-bg);
            border: 1px solid rgba(100, 255, 218, 0.3);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .image-input-container input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(46, 139, 87, 0.5);
            outline: none;
        }

        .image-input-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        /* Animations */
        @keyframes cardToMain {
            0% { 
                transform: scale(1) translateY(0); 
                z-index: 1;
            }
            50% { 
                transform: scale(1.2) translateY(-50px); 
                z-index: 10;
            }
            100% { 
                transform: scale(1.1) translateY(0); 
                z-index: 10;
            }
        }

        @keyframes mainToCard {
            0% { 
                transform: scale(1.1) translateY(0); 
                z-index: 10;
            }
            50% { 
                transform: scale(0.8) translateY(50px); 
                z-index: 1;
            }
            100% { 
                transform: scale(1) translateY(0); 
                z-index: 1;
            }
        }

        @keyframes slideOutToRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @keyframes slideOutToLeft {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-100%); opacity: 0; }
        }

        @keyframes slideInFromRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInFromLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes cardEnterFromRight {
            from { transform: translateX(100vw) scale(0.8); }
            to { transform: translateX(0) scale(1); }
        }

        @keyframes cardEnterFromLeft {
            from { transform: translateX(-100vw) scale(0.8); }
            to { transform: translateX(0) scale(1); }
        }

        @keyframes cardExitToRight {
            from { transform: translateX(0) scale(1); }
            to { transform: translateX(100vw) scale(0.8); }
        }

        @keyframes cardExitToLeft {
            from { transform: translateX(0) scale(1); }
            to { transform: translateX(-100vw) scale(0.8); }
        }

        .card-to-main {
            animation: cardToMain 0.5s ease-out forwards;
        }

        .main-to-card {
            animation: mainToCard 0.5s ease-out forwards;
        }

        .slide-out-right {
            animation: slideOutToRight 0.5s ease-out forwards;
        }

        .slide-out-left {
            animation: slideOutToLeft 0.5s ease-out forwards;
        }

        .slide-in-right {
            animation: slideInFromRight 0.5s ease-out forwards;
        }

        .slide-in-left {
            animation: slideInFromLeft 0.5s ease-out forwards;
        }

        .card-enter-right {
            animation: cardEnterFromRight 0.5s ease-out forwards;
        }

        .card-enter-left {
            animation: cardEnterFromLeft 0.5s ease-out forwards;
        }

        .card-exit-right {
            animation: cardExitToRight 0.5s ease-out forwards;
        }

        .card-exit-left {
            animation: cardExitToLeft 0.5s ease-out forwards;
        }
    </style>
</head>
<body>
    <div class="overlay">
        <!-- Modal de configuration du profil -->
        <div id="setup-modal">
            <div class="setup-container">
                <h2>Configuration du profil</h2>
                
                <div class="profile-preview" id="profile-preview">
                    <span id="profile-letter">?</span>
                    <img id="profile-preview-img">
                </div>
                
                <input type="text" id="username-input" placeholder="Votre nom d'utilisateur" maxlength="20" required>

                <p id="username-info" style="color: var(--text-secondary);">
                    Ce nom ne pourra pas être changé avant 48 heures
                </p>

                <button class="setup-btn" id="save-profile-btn">Enregistrer</button>
            </div>
        </div>

        <!-- Modal pour saisir le nom de l'image -->
        <div id="image-input-modal">
            <div class="image-input-container">
                <h3>Changer la photo de profil</h3>
                <p>Entrez le nom de la photo (sans extension .webp)</p>
                <input type="text" id="image-name-input" placeholder="nomdelaphoto" autocomplete="off">
                <div class="image-input-buttons">
                    <button class="logout-btn" id="cancel-image-btn">Annuler</button>
                    <button class="setup-btn" id="confirm-image-btn">Valider</button>
                </div>
            </div>
        </div>

        <!-- Interface principale -->
        <div id="main-interface" style="display: none;">
            <div class="container">
                <header>
                    <div class="logo">
                        <h1>SchoolReport</h1>
                    </div>

                    <div class="time-online">
                        <div class="time" id="current-time">00:00:00</div>
                        <div class="user-count" id="online-count">0 en ligne</div>
                    </div>

                    <div class="user-menu">
                        <div class="profile-badge">
                            <div class="user-avatar" id="user-avatar">
                                <img id="profile-pic">
                                <span id="avatar-letter">U</span>
                            </div>
                            <div class="online-status" id="online-status"></div>
                        </div>

                        <span class="user-name" id="user-name">Utilisateur</span>
                        <button class="logout-btn" id="logout-btn">Déconnexion</button>

                        <div class="users-list" id="users-list">
                            <h4>Utilisateurs en ligne</h4>
                            <div id="online-users-container"></div>
                        </div>
                    </div>
                </header>

                <div class="main-content">
                    <div class="profile-section">
                        <div class="profile-card">
                            <div class="profile-image">
                                <img id="main-profile-pic">
                                <div class="initials" id="profile-initials">U</div>
                            </div>
                            <h2 id="profile-username">Utilisateur</h2>
                            <p>Membre depuis <span id="member-since">aujourd'hui</span></p>
                        </div>

                        <div class="description-card" id="main-description-card">
                            <h3>Messagerie</h3>
                            <p>Discutez en temps réel avec vos amis et vos groupes de travail. Envoyez des messages, partagez des fichiers et collaborez facilement avec vos camarades de classe.</p>
                            <a href="chat.html" class="setup-btn" style="display: inline-block; margin-top: 15px; text-decoration: none;">Accéder au chat</a>
                        </div>
                    </div>

                    <div class="mini-cards-container" id="mini-cards-container">
                        <div class="mini-cards-track" id="mini-cards-track">
                            <div class="mini-card" data-target="workspace">
                                <img src="photos/mini_workspace.webp" alt="Espace de travail">
                                <div class="card-title">Espace de travail</div>
                            </div>
                            <div class="mini-card" data-target="homework">
                                <img src="photos/mini_homework.webp" alt="Devoirs">
                                <div class="card-title">Gestion des devoirs</div>
                            </div>
                            <div class="mini-card" data-target="calendar">
                                <img src="photos/mini_calendar.webp" alt="Calendrier">
                                <div class="card-title">Calendrier</div>
                            </div>
                            <div class="mini-card" data-target="grades">
                                <img src="photos/mini_grades.webp" alt="Notes">
                                <div class="card-title">Notes</div>
                            </div>
                            <div class="mini-card" data-target="resources">
                                <img src="photos/mini_resources.webp" alt="Ressources">
                                <div class="card-title">Ressources</div>
                            </div>
                            <div class="mini-card active" data-target="chat">
                                <img src="photos/mini_chat.webp" alt="Messagerie">
                                <div class="card-title">Messagerie</div>
                            </div>
                            <div class="mini-card" data-target="settings">
                                <img src="photos/mini_settings.webp" alt="Paramètres">
                                <div class="card-title">Paramètres</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script type="module">
            import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getDatabase, ref, set, onValue, update, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
            import { app, auth, db } from "./firebase/firebase-config.js";

            // Variables globales
            let currentUser = null;
            let currentUsername = '';
            let currentUserStatusRef = null;
            let pressTimer = null;
            let connectedUsersRef = null;
            let currentCardIndex = 5; // Commence par la carte "Messagerie"
            let isAnimating = false;
            const cardWidth = 150 + 25; // Largeur de la carte + gap
            const cardTargets = ['workspace', 'homework', 'calendar', 'grades', 'resources', 'chat', 'settings'];
            let lastScrollDirection = 'right'; // 'left' ou 'right'

            // Initialisation
            document.addEventListener('DOMContentLoaded', () => {
                initAuthState();
                setupEventListeners();
                updateClock();
                setInterval(updateClock, 1000);
            });

            function updateClock() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString();
                document.getElementById('current-time').textContent = timeStr;
            }

            function initAuthState() {
                onAuthStateChanged(auth, (user) => {
                    if (!user) {
                        window.location.href = 'index.html';
                    } else {
                        currentUser = user;
                        checkUserProfile(user);
                    }
                });
            }

            function checkUserProfile(user) {
                const userRef = ref(db, 'users/' + user.uid);
                
                onValue(userRef, (snapshot) => {
                    const userData = snapshot.val();
                    
                    if (userData && userData.username) {
                        // Profil existant
                        currentUsername = userData.username;
                        setupMainInterface(user, userData);
                    } else {
                        // Nouvel utilisateur
                        setupProfileConfiguration(user);
                    }
                }, { onlyOnce: true });
            }

            function setupProfileConfiguration(user) {
                const setupModal = document.getElementById('setup-modal');
                const usernameInput = document.getElementById('username-input');
                const saveBtn = document.getElementById('save-profile-btn');
                const profileLetter = document.getElementById('profile-letter');

                // Afficher le modal avec animation
                setTimeout(() => {
                    setupModal.classList.add('show');
                }, 100);

                // Mise à jour de l'initiale
                usernameInput.addEventListener('input', () => {
                    const username = usernameInput.value.trim();
                    profileLetter.textContent = username.length > 0 ? username.charAt(0).toUpperCase() : '?';
                });

                // Gestion de l'enregistrement
                saveBtn.addEventListener('click', async () => {
                    const username = usernameInput.value.trim();
                    
                    if (username.length < 3 || username.length > 20) {
                        alert("Le nom d'utilisateur doit contenir entre 3 et 20 caractères");
                        return;
                    }

                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Enregistrement...';

                    try {
                        await saveUserProfile(user, username);
                        setupModal.classList.remove('show');
                        
                        // Recharger les données utilisateur
                        const userRef = ref(db, 'users/' + user.uid);
                        onValue(userRef, (snapshot) => {
                            const userData = snapshot.val();
                            setupMainInterface(user, userData);
                        }, { onlyOnce: true });
                        
                    } catch (error) {
                        console.error("Erreur lors de l'enregistrement:", error);
                        alert("Une erreur est survenue lors de l'enregistrement");
                    } finally {
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Enregistrer';
                    }
                });
            }

            async function saveUserProfile(user, username) {
                const userRef = ref(db, 'users/' + user.uid);
                
                await set(userRef, {
                    username,
                    createdAt: Date.now(),
                    canChangeUsername: false,
                    lastSeen: Date.now(),
                    profileImage: localStorage.getItem(`profileImage_${user.uid}`) || null
                });

                currentUsername = username;
            }

            function setupMainInterface(user, userData) {
                const mainInterface = document.getElementById('main-interface');
                mainInterface.style.display = 'block';

                // Mise à jour des infos utilisateur
                updateUserInfo(userData);

                // Suivi des utilisateurs en ligne
                setupPresenceTracking(user);

                // Vérifier les devoirs urgents
                checkUrgentHomeworks(user);

                // Gestion de la déconnexion
                document.getElementById('logout-btn').addEventListener('click', handleLogout);

                // Gestion du clic long sur l'avatar
                setupLongPressAvatar();

                // Initialiser les mini-cards
                initMiniCards();
            }

            function updateUserInfo(userData) {
                document.getElementById('user-name').textContent = userData.username;
                document.getElementById('profile-username').textContent = userData.username;
                
                const avatarLetter = document.getElementById('avatar-letter');
                const profilePic = document.getElementById('profile-pic');
                const mainProfilePic = document.getElementById('main-profile-pic');
                const profileInitials = document.getElementById('profile-initials');
                
                avatarLetter.textContent = userData.username.charAt(0).toUpperCase();
                profileInitials.textContent = userData.username.charAt(0).toUpperCase();
                
                // Format member since date
                if (userData.createdAt) {
                    const joinDate = new Date(userData.createdAt);
                    const options = { year: 'numeric', month: 'long', day: 'numeric' };
                    document.getElementById('member-since').textContent = joinDate.toLocaleDateString('fr-FR', options);
                }
                
                // Vérifier si une image existe déjà
                if (userData.profileImage) {
                    profilePic.src = userData.profileImage;
                    profilePic.style.display = 'block';
                    avatarLetter.style.display = 'none';
                    
                    mainProfilePic.src = userData.profileImage;
                    mainProfilePic.style.display = 'block';
                    profileInitials.style.display = 'none';
                    
                    localStorage.setItem(`profileImage_${currentUser.uid}`, userData.profileImage);
                } else {
                    const savedImage = localStorage.getItem(`profileImage_${currentUser.uid}`);
                    if (savedImage) {
                        profilePic.src = savedImage;
                        profilePic.style.display = 'block';
                        avatarLetter.style.display = 'none';
                        
                        mainProfilePic.src = savedImage;
                        mainProfilePic.style.display = 'block';
                        profileInitials.style.display = 'none';
                    } else {
                        profilePic.style.display = 'none';
                        avatarLetter.style.display = 'flex';
                        
                        mainProfilePic.style.display = 'none';
                        profileInitials.style.display = 'flex';
                    }
                }
            }

            function checkUrgentHomeworks(user) {
                const homeworksRef = ref(db, `homeworks/${user.uid}`);
                const now = new Date();
                const twoDaysFromNow = new Date(now.getTime() + 48 * 60 * 60 * 1000);

                onValue(homeworksRef, (snapshot) => {
                    let urgentCount = 0;
                    const homeworks = snapshot.val();
                    if (homeworks) {
                        Object.values(homeworks).forEach((dateHomeworks) => {
                            Object.values(dateHomeworks).forEach((homework) => {
                                const dueDate = new Date(homework.dueDate);
                                if (dueDate <= twoDaysFromNow && !homework.completed) {
                                    urgentCount++;
                                }
                            });
                        });
                    }

                    // Mettre à jour l'indicateur sur la mini-card calendrier
                    const calendarCards = document.querySelectorAll('.mini-card[data-target="calendar"]');
                    calendarCards.forEach(card => {
                        if (urgentCount > 0) {
                            let indicator = card.querySelector('.active-indicator');
                            if (!indicator) {
                                indicator = document.createElement('div');
                                indicator.className = 'active-indicator';
                                card.appendChild(indicator);
                            }
                            indicator.textContent = urgentCount;
                            indicator.style.display = 'flex';
                        } else {
                            const indicator = card.querySelector('.active-indicator');
                            if (indicator) {
                                indicator.style.display = 'none';
                            }
                        }
                    });
                });
            }

            function setupPresenceTracking(user) {
                // Référence pour le suivi des utilisateurs connectés
                connectedUsersRef = ref(db, 'connectedUsers');
                
                // Référence pour l'utilisateur actuel
                currentUserStatusRef = ref(db, 'connectedUsers/' + user.uid);
                
                // Récupérer l'image de profil depuis le stockage local ou la base de données
                const profileImage = localStorage.getItem(`profileImage_${user.uid}`) || null;
                
                // Marquer l'utilisateur comme connecté avec toutes ses infos
                set(currentUserStatusRef, {
                    uid: user.uid,
                    username: currentUsername,
                    profileImage: profileImage,
                    timestamp: Date.now(),
                    firstLetter: currentUsername.charAt(0).toUpperCase()
                });

                // Supprimer la présence lors de la déconnexion
                onDisconnect(currentUserStatusRef).remove();
                
                // Écouter les changements dans la liste des utilisateurs connectés
                onValue(connectedUsersRef, (snapshot) => {
                    const connectedUsers = snapshot.val() || {};
                    const onlineUsers = [];
                    let onlineCount = 0;

                    // Compter les utilisateurs connectés et préparer la liste
                    Object.entries(connectedUsers).forEach(([uid, userData]) => {
                        if (uid !== user.uid) { // Exclure l'utilisateur actuel
                            onlineCount++;
                            onlineUsers.push({
                                userId: uid,
                                username: userData.username || 'Utilisateur',
                                firstLetter: userData.firstLetter || (userData.username || 'U').charAt(0).toUpperCase(),
                                profileImage: userData.profileImage || null
                            });
                        }
                    });

                    // Mettre à jour l'interface
                    updateOnlineUsersDisplay(onlineCount, onlineUsers);
                });
            }

            function updateOnlineUsersDisplay(onlineCount, onlineUsers) {
                // Mettre à jour le compteur
                document.getElementById('online-count').textContent = `${onlineCount} en ligne`;

                // Mettre à jour la liste des utilisateurs
                const container = document.getElementById('online-users-container');
                container.innerHTML = '';

                if (onlineUsers.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); font-size: 14px;">Aucun autre utilisateur en ligne</p>';
                } else {
                    onlineUsers.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'user-item';
                        
                        // Créer le contenu de l'avatar
                        let avatarContent = '';
                        if (user.profileImage) {
                            avatarContent = `<img src="${user.profileImage}" style="width:100%;height:100%;object-fit:cover;display:block;">`;
                        } else {
                            avatarContent = user.firstLetter;
                        }
                        
                        userElement.innerHTML = `
                            <div class="user-avatar-small">
                                ${avatarContent}
                            </div>
                            <span>${user.username}</span>
                        `;
                        container.appendChild(userElement);
                    });
                }
            }

            async function handleLogout() {
                try {
                    // Supprimer immédiatement la présence de l'utilisateur
                    if (currentUserStatusRef) {
                        await remove(currentUserStatusRef);
                    }
                    
                    // Déconnecter l'utilisateur
                    await signOut(auth);
                    
                    // Rediriger vers la page de connexion
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error("Erreur lors de la déconnexion:", error);
                    alert("Une erreur est survenue lors de la déconnexion");
                }
            }

            function setupEventListeners() {
                // Gestion de l'affichage de la liste des utilisateurs
                document.getElementById('online-count').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const usersList = document.getElementById('users-list');
                    usersList.classList.toggle('show');
                });

                // Fermer la liste quand on clique ailleurs
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.user-count') && !e.target.closest('.users-list')) {
                        document.getElementById('users-list').classList.remove('show');
                    }
                });

                // Gestion du modal d'import d'image
                document.getElementById('cancel-image-btn').addEventListener('click', () => {
                    document.getElementById('image-input-modal').classList.remove('show');
                });

                document.getElementById('confirm-image-btn').addEventListener('click', () => {
                    const imageName = document.getElementById('image-name-input').value.trim();
                    if (!imageName) return;
                    
                    handleImageImport(`photos/${imageName}.webp`);
                });

                // Gestion des touches du clavier
                document.addEventListener('keydown', (e) => {
                    if (isAnimating) return;
                    
                    if (e.key === 'ArrowLeft') {
                        navigateToCard((currentCardIndex - 1 + 7) % 7);
                        lastScrollDirection = 'left';
                    } else if (e.key === 'ArrowRight') {
                        navigateToCard((currentCardIndex + 1) % 7);
                        lastScrollDirection = 'right';
                    }
                });
            }

            function setupLongPressAvatar() {
                const avatar = document.getElementById('user-avatar');

                avatar.addEventListener('mousedown', () => {
                    pressTimer = setTimeout(() => {
                        showImageInputModal();
                    }, 1000); // 1 seconde pour un clic long
                });

                avatar.addEventListener('mouseup', () => {
                    clearTimeout(pressTimer);
                });

                avatar.addEventListener('mouseleave', () => {
                    clearTimeout(pressTimer);
                });

                // Pour les appareils tactiles
                avatar.addEventListener('touchstart', () => {
                    pressTimer = setTimeout(() => {
                        showImageInputModal();
                    }, 1000);
                });

                avatar.addEventListener('touchend', () => {
                    clearTimeout(pressTimer);
                });
            }

            function showImageInputModal() {
                const modal = document.getElementById('image-input-modal');
                modal.classList.add('show');
                document.getElementById('image-name-input').value = '';
                document.getElementById('image-name-input').focus();
            }

            function handleImageImport(imageUrl) {
                const img = new Image();
                
                img.onload = function() {
                    // L'image existe, on peut l'utiliser
                    const profilePic = document.getElementById('profile-pic');
                    const avatarLetter = document.getElementById('avatar-letter');
                    const mainProfilePic = document.getElementById('main-profile-pic');
                    const profileInitials = document.getElementById('profile-initials');
                    
                    profilePic.src = imageUrl;
                    profilePic.style.display = 'block';
                    avatarLetter.style.display = 'none';
                    
                    mainProfilePic.src = imageUrl;
                    mainProfilePic.style.display = 'block';
                    profileInitials.style.display = 'none';
                    
                    // Sauvegarder dans le stockage local
                    localStorage.setItem(`profileImage_${currentUser.uid}`, imageUrl);
                    
                    // Mettre à jour dans la base de données
                    const userRef = ref(db, 'users/' + currentUser.uid);
                    update(userRef, {
                        profileImage: imageUrl
                    });
                    
                    // Mettre à jour dans la liste des utilisateurs connectés
                    if (currentUserStatusRef) {
                        update(currentUserStatusRef, {
                            profileImage: imageUrl
                        });
                    }
                    
                    document.getElementById('image-input-modal').classList.remove('show');
                };
                
                img.onerror = function() {
                    alert("Image non trouvée. Vérifiez le nom et assurez-vous qu'elle est au format .webp dans le dossier photos/");
                };
                
                img.src = imageUrl;
            }

            function initMiniCards() {
                const miniCards = document.querySelectorAll('.mini-card');
                const track = document.getElementById('mini-cards-track');
                const container = document.getElementById('mini-cards-container');
                
                // Positionner initialement la track pour que la carte active soit au centre
                updateTrackPosition();
                
                // Gestion du clic sur les mini-cards
                miniCards.forEach((card, index) => {
                    card.addEventListener('click', function() {
                        if (isAnimating) return;
                        
                        const targetIndex = Array.from(miniCards).indexOf(this);
                        if (targetIndex === currentCardIndex) return;
                        
                        // Déterminer la direction du scroll
                        lastScrollDirection = targetIndex > currentCardIndex ? 'right' : 'left';
                        if (Math.abs(targetIndex - currentCardIndex) > 3) {
                            // Cas spécial pour le "loop"
                            lastScrollDirection = targetIndex > currentCardIndex ? 'left' : 'right';
                        }
                        
                        navigateToCard(targetIndex);
                    });
                });
                
                // Gestion du scroll horizontal
                let isDown = false;
                let startX;
                let scrollLeft;
                let lastScrollTime = 0;
                let velocity = 0;
                let lastFrameTime = 0;
                let animationFrameId = null;
                
                // Fonction pour animer l'inertie
                function animateInertia(timestamp) {
                    if (!lastFrameTime) lastFrameTime = timestamp;
                    const deltaTime = timestamp - lastFrameTime;
                    lastFrameTime = timestamp;
                    
                    if (Math.abs(velocity) > 0.1) {
                        container.scrollLeft += velocity * deltaTime / 16;
                        velocity *= 0.95; // Facteur de friction
                        animationFrameId = requestAnimationFrame(animateInertia);
                    } else {
                        velocity = 0;
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                        
                        // Snap to nearest card after inertia
                        const cardIndex = Math.round(container.scrollLeft / cardWidth);
                        navigateToCard(cardIndex);
                    }
                }
                
                container.addEventListener('mousedown', (e) => {
                    isDown = true;
                    startX = e.pageX - container.offsetLeft;
                    scrollLeft = container.scrollLeft;
                    lastScrollTime = Date.now();
                    velocity = 0;
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                    }
                });
                
                container.addEventListener('mouseleave', () => {
                    isDown = false;
                });
                
                container.addEventListener('mouseup', () => {
                    isDown = false;
                    const now = Date.now();
                    const deltaTime = now - lastScrollTime;
                    
                    if (deltaTime > 0) {
                        const deltaX = container.scrollLeft - scrollLeft;
                        velocity = deltaX / deltaTime * 10; // Calcul de la vitesse
                        
                        if (Math.abs(velocity) > 1) {
                            animationFrameId = requestAnimationFrame(animateInertia);
                        } else {
                            // Snap to nearest card if slow movement
                            const cardIndex = Math.round(container.scrollLeft / cardWidth);
                            navigateToCard(cardIndex);
                        }
                    }
                });
                
                container.addEventListener('mousemove', (e) => {
                    if(!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - container.offsetLeft;
                    const walk = (x - startX) * 2;
                    container.scrollLeft = scrollLeft - walk;
                });
                
                // Pour les appareils tactiles
                container.addEventListener('touchstart', (e) => {
                    isDown = true;
                    startX = e.touches[0].pageX - container.offsetLeft;
                    scrollLeft = container.scrollLeft;
                    lastScrollTime = Date.now();
                    velocity = 0;
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                    }
                }, { passive: false });
                
                container.addEventListener('touchend', () => {
                    isDown = false;
                    const now = Date.now();
                    const deltaTime = now - lastScrollTime;
                    
                    if (deltaTime > 0) {
                        const deltaX = container.scrollLeft - scrollLeft;
                        velocity = deltaX / deltaTime * 10; // Calcul de la vitesse
                        
                        if (Math.abs(velocity) > 1) {
                            animationFrameId = requestAnimationFrame(animateInertia);
                        } else {
                            // Snap to nearest card if slow movement
                            const cardIndex = Math.round(container.scrollLeft / cardWidth);
                            navigateToCard(cardIndex);
                        }
                    }
                });
                
                container.addEventListener('touchmove', (e) => {
                    if(!isDown) return;
                    e.preventDefault();
                    const x = e.touches[0].pageX - container.offsetLeft;
                    const walk = (x - startX) * 2;
                    container.scrollLeft = scrollLeft - walk;
                }, { passive: false });
            }
            
            function navigateToCard(targetIndex) {
                if (isAnimating) return;
                isAnimating = true;
                
                const miniCards = document.querySelectorAll('.mini-card');
                const descriptionCard = document.getElementById('main-description-card');
                const currentCard = miniCards[currentCardIndex];
                const targetCard = miniCards[targetIndex];
                
                // Animation de la mini-card actuelle qui redevient normale
                currentCard.classList.remove('active');
                currentCard.classList.add('main-to-card');
                
                // Animation de la mini-card cible qui devient principale
                targetCard.classList.add('card-to-main');
                
                // Animation des cartes adjacentes
                miniCards.forEach((card, index) => {
                    if (index !== currentCardIndex && index !== targetIndex) {
                        if (lastScrollDirection === 'right') {
                            if (index > currentCardIndex && index < targetIndex) {
                                card.classList.add('card-exit-left');
                            } else if (index < currentCardIndex || index > targetIndex) {
                                card.classList.add('card-enter-right');
                            }
                        } else {
                            if (index < currentCardIndex && index > targetIndex) {
                                card.classList.add('card-exit-right');
                            } else if (index > currentCardIndex || index < targetIndex) {
                                card.classList.add('card-enter-left');
                            }
                        }
                    }
                });
                
                setTimeout(() => {
                    // Mettre à jour l'index courant
                    currentCardIndex = targetIndex;
                    
                    // Mettre à jour la position de la track
                    updateTrackPosition();
                    
                    // Mettre à jour la description card
                    updateDescriptionCard(targetCard.getAttribute('data-target'), lastScrollDirection);
                    
                    // Finaliser les animations
                    setTimeout(() => {
                        targetCard.classList.add('active');
                        targetCard.classList.remove('card-to-main');
                        currentCard.classList.remove('main-to-card');
                        
                        // Réinitialiser les animations des autres cartes
                        miniCards.forEach(card => {
                            card.classList.remove('card-exit-left', 'card-exit-right', 'card-enter-left', 'card-enter-right');
                        });
                        
                        isAnimating = false;
                    }, 500);
                }, 300);
            }
            
            function updateTrackPosition() {
                const track = document.getElementById('mini-cards-track');
                const containerWidth = document.querySelector('.mini-cards-container').offsetWidth;
                const targetPosition = (containerWidth / 2) - (cardWidth / 2) - (currentCardIndex * cardWidth);
                
                track.style.transform = `translateX(${targetPosition}px)`;
            }
            
            function updateDescriptionCard(target, direction) {
                const descriptionCard = document.getElementById('main-description-card');
                
                // Animation de sortie
                descriptionCard.classList.add(direction === 'right' ? 'slide-out-left' : 'slide-out-right');
                
                setTimeout(() => {
                    // Mettre à jour le contenu
                    let newContent = '';
                    switch(target) {
                        case 'workspace':
                            newContent = `
                                <h3>Espace de travail</h3>
                                <p>Collaborez sur des documents en temps réel avec votre équipe. Créez, modifiez et partagez des fichiers avec vos camarades de classe et enseignants. L'espace de travail vous permet de garder tous vos documents scolaires organisés et accessibles où que vous soyez.</p>
                                <a href="Codex.html" class="setup-btn" style="display: inline-block; margin-top: 15px; text-decoration: none;">Ouvrir l'espace</a>
                            `;
                            break;
                        case 'homework':
                            newContent = `
                                <h3>Gestion des devoirs</h3>
                                <p>Organisez vos devoirs et projets avec des échéances claires. Recevez des rappels et suivez votre progression dans vos travaux scolaires. Le système de gestion des devoirs vous aide à rester organisé et à ne rien oublier.</p>
                                <a href="homework.html" class="setup-btn" style="display: inline-block; margin-top: 15px; text-decoration: none;">Voir les devoirs</a>
                            `;
                            break;
                        case 'calendar':
                            newContent = `
                                <h3>Calendrier et Planning</h3>
                                <p>Planifiez vos cours, consultez vos emplois du temps et suivez vos devoirs à rendre. Ne manquez plus jamais une échéance importante. Le calendrier intégré synchronise tous vos événements scolaires et personnels.</p>
                                <a href="calendar.html" class="setup-btn" style="display: inline-block; margin-top: 15px; text-decoration: none;">Voir le planning</a>
                            `;
                            break;
                        case 'grades':
                            newContent = `
                                <h3>Notes et Évaluations</h3>
                                <p>Consultez vos résultats scolaires, suivez votre progression et comparez vos performances avec les moyennes de classe. Analysez vos forces et vos faiblesses pour améliorer vos résultats.</p>
                                <a href="grades.html" class="setup-btn" style="display: inline-block; margin-top: 15px; text-decoration: none;">Voir les notes</a>
                            `;
                            break;
                        case 'resources':
                            newContent = `
                                <h3>Ressources pédagogiques</h3>
                                <p>Accédez à toutes vos ressources de cours, documents partagés par les enseignants et supports d'étude pour vos révisions. Toutes vos ressources scolaires organisées au même endroit.</p>
                                <a href="resources.html" class="setup-btn" style="display: inline-block; margin-top: 15px; text-decoration: none;">Accéder aux ressources</a>
                            `;
                            break;
                        case 'settings':
                            newContent = `
                                <h3>Paramètres du compte</h3>
                                <p>Personnalisez votre expérience en modifiant vos préférences, votre profil et les paramètres de notification. Configurez SchoolReport selon vos besoins.</p>
                                <a href="settings.html" class="setup-btn" style="display: inline-block; margin-top: 15px; text-decoration: none;">Ouvrir les paramètres</a>
                            `;
                            break;
                        default: // 'chat'
                            newContent = `
                                <h3>Messagerie</h3>
                                <p>Discutez en temps réel avec vos amis et vos groupes de travail. Envoyez des messages, partagez des fichiers et collaborez facilement avec vos camarades de classe. La communication simplifiée pour votre réussite scolaire.</p>
                                <a href="chat.html" class="setup-btn" style="display: inline-block; margin-top: 15px; text-decoration: none;">Accéder au chat</a>
                            `;
                    }
                    
                    descriptionCard.innerHTML = newContent;
                    descriptionCard.classList.remove('slide-out-left', 'slide-out-right');
                    descriptionCard.classList.add(direction === 'right' ? 'slide-in-right' : 'slide-in-left');
                    
                    setTimeout(() => {
                        descriptionCard.classList.remove('slide-in-right', 'slide-in-left');
                    }, 500);
                }, 300);
            }
        </script>
    </div>
</body>
</html>
