<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatFriends ITC - Avanc√©</title>
  <style>
    /* ... (le CSS reste inchang√©) ... */
  </style>
</head>
<body>
<div class="chat-container">
  <div class="user-list" id="userList">
    <strong>Utilisateurs connect√©s</strong>
  </div>
  <div class="chat-box">
    <div class="messages" id="messages"></div>
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="Tapez un message..." autocomplete="off">
      <input type="file" id="imageInput" accept="image/*">
      <button id="sendButton">Envoyer</button>
      <button id="recordBtn">üéôÔ∏è</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { 
  getFirestore, collection, addDoc, query,
  orderBy, onSnapshot, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { 
  getStorage, ref, uploadBytes, getDownloadURL 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAgbZ8YHHPbaKWmEMzwI65jXflv-8qYCVM",
  authDomain: "schoolreport-f8db0.firebaseapp.com",
  projectId: "schoolreport-f8db0",
  storageBucket: "schoolreport-f8db0.appspot.com",
  messagingSenderId: "313069994450",
  appId: "1:313069994450:web:37b009be4f1812fdca880b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
let selectedUserId = null;
let selectedUserName = "";

// √âl√©ments du DOM
const messagesDiv = document.getElementById("messages");
const messageInput = document.getElementById("messageInput");
const sendButton = document.getElementById("sendButton");
const imageInput = document.getElementById("imageInput");
const userListDiv = document.getElementById("userList");

// Gestion de l'authentification
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = 'index.html';
    return;
  }
  
  currentUser = user;
  await loadUsers();
  
  // Activer l'envoi avec la touche Entr√©e
  messageInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      sendMessage();
    }
  });
  
  sendButton.addEventListener("click", sendMessage);
});

async function loadUsers() {
  userListDiv.innerHTML = "<strong>Utilisateurs connect√©s</strong>";
  
  try {
    const usersSnap = await getDocs(collection(db, "users"));
    
    usersSnap.forEach(docSnap => {
      const userData = docSnap.data();
      const uid = docSnap.id;
      
      if (uid !== currentUser.uid) {
        const div = document.createElement("div");
        div.className = "user-item";
        div.textContent = userData.username || "Utilisateur";
        div.onclick = () => {
          selectedUserId = uid;
          selectedUserName = userData.username;
          loadMessages(uid);
        };
        userListDiv.appendChild(div);
      }
    });
    
    // S√©lectionner le premier utilisateur par d√©faut
    if (usersSnap.docs.length > 1) {
      const firstUser = usersSnap.docs.find(doc => doc.id !== currentUser.uid);
      if (firstUser) {
        selectedUserId = firstUser.id;
        selectedUserName = firstUser.data().username;
        loadMessages(firstUser.id);
      }
    }
  } catch (error) {
    console.error("Erreur chargement utilisateurs:", error);
  }
}

async function loadMessages(uid) {
  messagesDiv.innerHTML = "";
  
  if (!uid) return;
  
  const chatId = generateChatId(currentUser.uid, uid);
  const q = query(
    collection(db, `private_messages/${chatId}/messages`), 
    orderBy("timestamp")
  );
  
  onSnapshot(q, (snapshot) => {
    messagesDiv.innerHTML = "";
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      displayMessage(data);
    });
    scrollToBottom();
  });
}

function generateChatId(uid1, uid2) {
  return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
}

function displayMessage(data) {
  const div = document.createElement("div");
  div.className = "message" + (data.sender === currentUser.uid ? " self" : "");
  
  let content = "";
  if (data.text) content += data.text;
  if (data.imageUrl) content += `<br><img src='${data.imageUrl}' alt='image'>`;
  if (data.audioUrl) content += `<br><audio controls src='${data.audioUrl}'></audio>`;
  
  div.innerHTML = `
    ${content}
    <div class='meta'>
      ${data.sender === currentUser.uid ? 'Moi' : selectedUserName}
      ${data.edited ? ' (modifi√©)' : ''}
    </div>
  `;
  
  messagesDiv.appendChild(div);
}

async function sendMessage() {
  if (!selectedUserId) {
    alert("Veuillez s√©lectionner un utilisateur");
    return;
  }

  const text = messageInput.value.trim();
  const file = imageInput.files[0];
  
  if (!text && !file) return;

  try {
    const chatId = generateChatId(currentUser.uid, selectedUserId);
    let messageData = {
      sender: currentUser.uid,
      timestamp: serverTimestamp()
    };

    if (file) {
      const filePath = `chat_images/${Date.now()}_${file.name}`;
      const imageRef = ref(storage, filePath);
      await uploadBytes(imageRef, file);
      messageData.imageUrl = await getDownloadURL(imageRef);
    }

    if (text) {
      messageData.text = text;
    }

    await addDoc(collection(db, `private_messages/${chatId}/messages`), messageData);
    
    messageInput.value = "";
    imageInput.value = "";
    scrollToBottom();
  } catch (error) {
    console.error("Erreur envoi message:", error);
    alert("Erreur lors de l'envoi du message");
  }
}

function scrollToBottom() {
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Gestion de l'enregistrement audio (optionnel)
document.getElementById("recordBtn").onclick = async () => {
  if (!selectedUserId) {
    alert("Veuillez s√©lectionner un utilisateur");
    return;
  }
  
  if (!navigator.mediaDevices) {
    alert("Enregistrement audio non support√©");
    return;
  }
  
  // ... (impl√©mentation de l'enregistrement audio si n√©cessaire)
};
</script>
</body>
</html>
